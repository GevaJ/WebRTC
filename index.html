<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ghost Protocol v5 - Final</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Courier New', monospace; 
            background: #000; color: #0f0; 
            display: flex; flex-direction: column; 
            height: 100dvh; margin: 0; overflow: hidden;
            transition: box-shadow 0.1s;
        }

        header {
            background: #111; padding: 10px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .timer { color: red; font-weight: bold; font-size: 0.9rem; }
        .panic-btn {
            background: #d00; color: white; border: none; padding: 8px 12px;
            font-weight: bold; font-size: 0.8rem; border-radius: 4px; box-shadow: 0 0 10px #500;
        }

        .config-area {
            background: #050505; padding: 10px; border-bottom: 1px solid #222;
            display: flex; flex-direction: column; gap: 10px;
        }
        .id-row {
            display: flex; align-items: center; justify-content: space-between;
            background: #151515; padding: 10px; border-radius: 4px; border: 1px solid #333;
        }
        .copy-btn {
            background: #00cc00; color: #000; border: none; padding: 5px 15px;
            font-weight: bold; cursor: pointer; border-radius: 3px;
        }

        #chat { flex: 1; overflow-y: auto; padding: 15px; background: #000; font-size: 1rem; }
        #chat div { margin-bottom: 8px; line-height: 1.4; }

        .input-group { display: flex; gap: 5px; }
        input {
            flex: 1; background: #000; color: #0f0; border: 1px solid #444;
            padding: 12px; font-size: 16px; border-radius: 4px; font-family: monospace; outline: none;
        }
        ::placeholder { color: #00ff00; opacity: 1; font-weight: bold; }
        
        button.action-btn { background: #111; color: #0f0; border: 1px solid #0f0; padding: 0 15px; font-weight: bold; border-radius: 4px; }
        button.send-btn { background: #0f0; color: #000; border: none; padding: 0 20px; font-weight: bold; border-radius: 4px; }

        footer { padding: 10px; background: #111; border-top: 1px solid #333; }
        .system-msg { color: #666; font-size: 0.8em; }
        .blink { box-shadow: inset 0 0 20px #0f0; }
    </style>
</head>
<body>

<header>
    <div id="timer-display" class="timer">OFFLINE</div>
    <button class="panic-btn" onclick="triggerPanic()">âš  WIPE ALL</button>
</header>

<div class="config-area">
    <div class="id-row">
        <span>MY ID: <strong id="my-id" style="color:#fff; font-size:1.2em;">...</strong></span>
        <button class="copy-btn" onclick="copyId()">COPY</button>
    </div>
    <input type="password" id="secret-key" placeholder="PASSWORD KEY">
    <div class="input-group">
        <input type="text" id="peer-id-input" placeholder="PARTNER ID">
        <button class="action-btn" onclick="connectToPeer()">LINK</button>
    </div>
</div>

<div id="chat"><div class="system-msg">> Waiting for handshake...</div></div>

<footer>
    <div class="input-group">
        <input type="text" id="message-input" placeholder="Type /clear or message..." autocomplete="off">
        <button class="send-btn" onclick="sendMessage()">SEND</button>
    </div>
</footer>

<script>
    const shortId = Math.random().toString(36).substring(2, 6).toUpperCase();
    
    // Tor/VPN Friendly Config
    const peer = new Peer(shortId, {
        config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }, { url: 'stun:stun1.l.google.com:19302' }] },
        debug: 0
    });

    let conn;
    let timerStarted = false;

    function playHackerSound() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const t = ctx.currentTime;
            const play = (f, s, d) => {
                const o = ctx.createOscillator(), g = ctx.createGain();
                o.type = 'square'; o.frequency.setValueAtTime(f, t + s);
                g.gain.setValueAtTime(0.05, t + s); g.gain.exponentialRampToValueAtTime(0.01, t + s + d);
                o.connect(g); g.connect(ctx.destination);
                o.start(t + s); o.stop(t + s + d);
            };
            play(1200, 0, 0.05); play(1800, 0.06, 0.08);
        } catch(e) {}
    }

    function visualBlink() {
        document.body.classList.add('blink');
        setTimeout(() => document.body.classList.remove('blink'), 150);
    }

    document.getElementById('message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
    });

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { conn = c; setupChat(); });

    function connectToPeer() {
        const tid = document.getElementById('peer-id-input').value.toUpperCase();
        if(!tid) return;
        conn = peer.connect(tid);
        setupChat();
    }

    function setupChat() {
        conn.on('data', (data) => {
            const p = JSON.parse(data);
            if (p.type === 'panic') { 
                document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:40vh;'>WIPED</h1>";
                setTimeout(() => location.reload(), 1000); 
                return; 
            }
            if (p.type === 'msg') {
                const key = document.getElementById('secret-key').value;
                const b = CryptoJS.AES.decrypt(p.payload, key);
                const txt = b.toString(CryptoJS.enc.Utf8);
                if (txt) { playHackerSound(); visualBlink(); appendMessage("GHOST", txt); if (!timerStarted) startDestructTimer(); }
            }
        });
        conn.on('open', () => { appendMessage("SYSTEM", "SECURE LINK ESTABLISHED"); startDestructTimer(); });
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const key = document.getElementById('secret-key').value;
        
        if (input.value === '/clear') {
            document.getElementById('chat').innerHTML = '<div class="system-msg">> Screen cleared.</div>';
            input.value = ""; return;
        }

        if (!key || !input.value || !conn || !conn.open) return;
        const enc = CryptoJS.AES.encrypt(input.value, key).toString();
        conn.send(JSON.stringify({ type: 'msg', payload: enc }));
        appendMessage("YOU", input.value);
        input.value = "";
    }

    function appendMessage(s, t) {
        const chat = document.getElementById('chat');
        const div = document.createElement('div');
        const c = s === "YOU" ? "#0f0" : (s === "SYSTEM" ? "#666" : "#00bcd4");
        div.innerHTML = `<strong style="color:${c}">${s}:</strong> ${t}`;
        chat.appendChild(div); chat.scrollTop = chat.scrollHeight;
    }

    function triggerPanic() {
        if (conn && conn.open) conn.send(JSON.stringify({ type: 'panic' }));
        setTimeout(() => location.reload(), 800);
    }

    function startDestructTimer() {
        if (timerStarted) return;
        timerStarted = true;
        let tl = 30 * 60;
        setInterval(() => {
            let m = Math.floor(tl / 60), s = tl % 60;
            document.getElementById('timer-display').innerText = `WIPE: ${m}:${s<10?'0':''}${s}`;
            if (tl-- <= 0) location.reload();
        }, 1000);
    }

    function copyId() {
        navigator.clipboard.writeText(document.getElementById('my-id').innerText);
        const b = document.querySelector('.copy-btn'); b.innerText = "COPIED";
        setTimeout(() => b.innerText = "COPY", 1000);
    }
</script>
</body>
</html>
