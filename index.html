<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Protocol - Hive Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #header { background: #222; padding: 10px; text-align: center; border-bottom: 2px solid #333; }
        .box { background: #111; border: 1px solid #333; padding: 15px; margin: 10px; border-radius: 5px; }
        input { background: #000; color: #0f0; border: 1px solid #444; padding: 10px; width: 100%; margin: 5px 0; box-sizing: border-box; font-size: 16px; }
        button { background: #0f0; color: #000; border: none; padding: 10px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; }
        #logs { flex: 1; overflow-y: auto; padding: 15px; font-size: 12px; border-top: 1px solid #222; }
        .log-rx { color: #00bcd4; } .log-tx { color: #0f0; } .log-err { color: #f00; } .log-sys { color: #ff0; }
    </style>
</head>
<body>

<div id="header">STATUS: <span id="status">DISCONNECTED</span></div>

<div class="box">
    <label>1. PASSWORD (AES):</label>
    <input type="text" id="password" value="1">
    <label>2. CHANNEL ID (Both must match):</label>
    <input type="text" id="channel" placeholder="Example: MyPrivateRoom123">
    <button onclick="initConnection()">CONNECT TO CHANNEL</button>
</div>

<div id="logs"></div>

<div class="box" style="display:flex; gap:5px;">
    <input type="text" id="msg-input" placeholder="Secure Message..." onkeypress="if(event.key==='Enter') send()">
    <button onclick="send()" style="width:80px; margin:0;">SEND</button>
</div>

<script>
    let client;
    let channelId;

    function log(msg, type = "sys") {
        const logs = document.getElementById('logs');
        const div = document.createElement('div');
        div.className = `log-${type}`;
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
    }

    function initConnection() {
        channelId = document.getElementById('channel').value;
        if(!channelId) return log("Enter Channel ID!", "err");

        log(`Connecting to Hive-Relay...`, "sys");
        // שימוש בברוקר MQTT ציבורי שפתוח ל-Websockets
        client = new Paho.MQTT.Client("broker.hivemq.com", 8000, "ghost_" + Math.random().toString(16).substr(2, 8));

        client.onConnectionLost = (obj) => {
            document.getElementById('status').innerText = "OFFLINE";
            log("Connection Lost: " + obj.errorMessage, "err");
        };

        client.onMessageArrived = (msg) => {
            log(`RAW RX INCOMING...`, "sys");
            try {
                const pass = document.getElementById('password').value;
                const bytes = CryptoJS.AES.decrypt(msg.payloadString, pass);
                const decoded = bytes.toString(CryptoJS.enc.Utf8);
                if(decoded) {
                    log(`GHOST: ${decoded}`, "rx");
                    playHackerSound();
                } else {
                    log("Decrypt failed - wrong password?", "err");
                }
            } catch(e) { log("Error processing message", "err"); }
        };

        client.connect({
            onSuccess: () => {
                document.getElementById('status').innerText = "ONLINE";
                document.getElementById('status').style.color = "#0f0";
                log(`JOINED CHANNEL: ${channelId}`, "sys");
                client.subscribe("ghost/chat/" + channelId);
            },
            useSSL: false, // Tor לפעמים מעדיף בלי SSL בתוך Websockets פשוטים
            timeout: 3
        });
    }

    function send() {
        const input = document.getElementById('msg-input');
        const pass = document.getElementById('password').value;
        if(!client || !input.value) return;

        const encrypted = CryptoJS.AES.encrypt(input.value, pass).toString();
        const message = new Paho.MQTT.Message(encrypted);
        message.destinationName = "ghost/chat/" + channelId;
        client.send(message);

        log(`YOU: ${input.value}`, "tx");
        input.value = "";
    }

    function playHackerSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'square'; o.frequency.setValueAtTime(1000, ctx.currentTime);
        g.gain.setValueAtTime(0.05, ctx.currentTime);
        o.connect(g); g.connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime + 0.1);
    }
</script>
</body>
</html>
